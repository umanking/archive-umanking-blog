---
layout: post
title: "[JPA] Audit 기능 사용하기"
categories: JPA
redirect_from: 
- 2019/04/12/jpa-audit/
date: 2019-04-12 09:09:31
---

JPA가 제공하는 Audit기능을 알아보자.
>  Audit은 주로 DB값이 변경했을 때 누가 값을 변경했고, 언제 변경했는지 감사를 하는 용도로 사용한다. 
> createdBy, lastModifieddBy, createdAt, lastModifiedAt 이런 식으로 사용한다.

## 1. 예제 코드

```java
@Data
@Entity
public class Comment {

    @Id
    @GeneratedValue
    private Long id;
    private String comment;

  // 생략
```



```java
// 생략
@CreatedDate
private Date created;

@CreatedBy
@ManyToOne
private Account createdBy;

@LastModifiedDate
private Date updated;

@LastModifiedBy
@ManyToOne
private Account updatedBy;

```

Comment 엔티티의 누가 만들었고, 만든 날짜, 누가 업데이트 했고, 업데이트한 날짜를 기록하는 Audit을 추가하고 싶다. 해당 필드에 `@CreatedDate` `@CreatedBy` `@LastModifiedDate` `@LastModifiedBy` 어노테이션을 붙인다.

### AuditorAware 구현

```java
@SpringBootApplication
@EnableJpaAuditing
public class Application {

    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }

}
```

SpringBoot를 사용하더라도 `@EnableJpaAuditing` 은 추가해줘야 한다. 이렇게 하고 테스트를 돌려보면 Date 값은 들어가지만, createdBy, updatedBy (누가) 한 정보는 들어가지 않는다. 이 부분은 Spring Security를 통해서 가져온다.

```java
@Data
@Entity
@EntityListeners(AuditingEntityListener.class)
public class Comment {

    @Id
    @GeneratedValue
    private Long id;
    private String comment;

  // 생략
```

엔티티 클래스 레벨에 `@EntityListeners(AuditingEntityListner.class)` 를 통해서 엔티티의 변화를 감지하는 리스너를 추가해준다.

```java
@Entity
@Data
public class Account {

    @Id
    @GeneratedValue
    private Long id;

    private String username;
    private String password;
}
```

간단한 Account 정보

```java
@Service
public class AccountAwareAudit implements AuditorAware<Comment> {
    @Override
    public Optional<Comment> getCurrentAuditor() {

        System.out.println("get current user");

        return Optional.empty();
    }
```

AccountAwareAudit 이라는 클래스를 만들고 `AuditorAware` 인터페이스를 구현한다. 구현 부 실제 내용은 다음과 같다.

하지만, 우리는 콘솔만 찍어서 `get current user` 라 찍히는 지 일단 확인한다.

```java
@Service
public class AccountAwareAudit implements AuditorAware<Comment> {
    @Override
    public Optional<Comment> getCurrentAuditor() {

          Authentication authentication =            SecurityContextHolder.getContext().getAuthentication();

            if (authentication == null || !authentication.isAuthenticated()) {
                return null;
            }

            return ((MyUserDetails) authentication.getPrincipal()).getUser();

    }
```

이렇게 만든 빈을 알 수 있도록 다음과 같이 등록한다.

```java
@SpringBootApplication
@EnableJpaAuditing(auditorAwareRef = "accountAwareAudit")
public class Application {

    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }

}
```

테스트 케이스를 돌리면, 만든 날짜, 만든 사람(여기에서 실제 구현은 안함)이 정상적으로 들어간다.

## 2\. JPA 라이프 사이클 이용

해당 엔티티의 변화를 감지해서, 전/후 동작을 직접 정의해서 사용할 수 있다. 위의 복잡하게 auditing을 설정하지 않아도 간단하게 Comment 엔티티에 정의해서 사용 가능

```java
@Data
@Entity
public class Comment {

        // 생략 

    @CreatedDate
    private Date created;

    @CreatedBy
    @ManyToOne
    private Account createdBy;

    @LastModifiedDate
    private Date updated;

    @LastModifiedBy
    @ManyToOne
    private Account updatedBy;

    @PrePersist
    public void prePersist() {
        System.out.println("pre Persist");
        this.created = new Date();
        this.updated = new Date();
    }
```

`@PrePersist` 를 통해서 persist 되기 전 날짜 정보와 누가 했는지에 대한 정보를 정의할 수 있다.

- [JpaLifeCycle](https://www.objectdb.com/java/jpa/persistence/advanced)

## 정리

엔티티의 변화를 추적하는 Audit에 대해서 알아보았다.

1. AuditorAware를 구현하는 방법
   1. Root `@EnableJpaAuditing(auditorAwareRef = "accountAwareAudit")`
   2. 해당 엔티티에 리스너 등록 `@EntityListeners(AuditingEntityListner.class)`
   3. AuditorAware 인터페이스 구현 (user정보 세팅 From Spring Security)
2. Jpa 라이프 사이클로 간편하게 구현 하는 방법